<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="assets/css/reset.css" />
    <style type="text/css"> 
      html, body {
        height: 100%;
      }
      #visualization {
        top: 5%;
        left: 5%;
        position: absolute;
        height: 90%;
        width: 90%;
      }
      p {
        margin-bottom: 10px;
      }
    </style>

    <script src="../carrotsearch.circles.js"></script>
    <script src="../carrotsearch.circles.asserts.js"></script>
    <script src="assets/js/carrotsearch.examples.onresizehook.js"></script>
    <script src="assets/js/carrotsearch.examples.viewport.js"></script>
  </head>

  <body>
    <div style="font: 16px sans-serif; width: 25%; margin: 20px; position: absolute; z-index: 1">
      <p>
        This demo shows how to process and display some of the server access
        statistics generated by <a href="http://goaccess.prosoftcorp.com/">GoAccess</a>.
        The specific data shows the numbers of downloads of various binary
        packages distributed by the <a href="http://project.carrot2.org">Carrot<sup>2</sup> project</a>.
      </p>
      <p>
        Show downloads
        <a href="#packages">by package</a> |
        <a href="#locations">by location</a>
      </p>
    </div>
    <div id="visualization"></div>

    <script>
      var accessData;
      window.addEventListener("load", function() {
        // Initialize the visualization
        var circles = new CarrotSearchCircles({
          id: "visualization",
          pixelRatio: Math.min(1.5, window.devicePixelRatio || 1),
          visibleGroupCount: 0,
          titleBar: "inscribed",
          titleBarTextColor: "#000",
          titleBarLabelDecorator: function(attrs) {
            if (attrs.hoverGroup) {
              attrs.label = attrs.hoverGroup.label + " (" + attrs.hoverGroup.weight + ")";
            }
          }
        });
        installResizeHandlerFor(circles, 0);

        document.querySelector("a[href ='#packages']").addEventListener("click", byPackage);
        document.querySelector("a[href ='#locations']").addEventListener("click", byLocation);
        byPackage();

        function byPackage() {
          // Parse the summary produced by GoAccess to extract product names and versions
          var productRequests = accessData.requests.filter(function(hit) {
            if (hit.data.slice(0, "/stable".length) === "/stable") {
              var split = hit.data.slice(1).split("/");
              return split.length === 3;
            }
          });

          var products = productRequests.reduce(function (index, hit) {
            var split = hit.data.slice(1).split("/");

            var version = split[1];
            var product = split[2].substring(0, split[2].indexOf(version) - 1);
            if (product !== "") {
              var hits = parseInt(hit.hits);

              if (index[product] === undefined) {
                index[product] = {
                  hits: 0,
                  name: product,
                  versions: { }
                }
              }
              index[product].hits += hits;
              if (index[product].versions[version] === undefined) {
                index[product].versions[version] = {
                  version: version,
                  hits: 0
                }
              }
              index[product].versions[version].hits += hits;
            }
            return index;


            function addToIndex(index, key, value) {
              if (index[key] === undefined) {
                index[key] = 0;
              }
              index[key] += value;
            }
          }, {});

          // For each product name, create a top-level group.
          // Add subgroups for specific versions.
          var downloadGroups = objectProperties(products).map(function (product) {
            return {
              label: product.name,
              weight: product.hits,
              groups: objectProperties(product.versions).map(function (version) {
                return {
                  label: version.version,
                  weight: version.hits
                }
              })
            }
          });
          circles.set("dataObject", { groups: downloadGroups });
        }

        function byLocation() {
          var locationGroups = accessData.geolocation.map(function(continent) {
            return {
              label: continent.data.slice(3),
              weight: continent.hits,
              groups: continent.items.map(function (country) {
                return {
                  label: country.data.slice(3),
                  weight: country.hits
                }
              })
            }
          });
          circles.set("dataObject", { groups: locationGroups });
        }

        function objectProperties(object) {
          return Object.keys(object).sort().map(function (key) {
            return object[key];
          });
        }
      });

      function modelDataAvailable(data) {
        accessData = data;
      }
    </script>
    <script src="assets/data/accesslogs.jsonp"></script>
  </body>
</html>
